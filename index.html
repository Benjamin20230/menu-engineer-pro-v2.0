<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu Engineer Pro — Sin Babel</title>
  <meta name="description" content="App gratuita para Menu Engineering (sin Babel): clasifica ítems y calcula márgenes/popularidad.">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/preact@10.19.6/dist/preact.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/preact@10.19.6/hooks.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/htm@3.1.1/dist/htm.umd.js"></script>
  <style>body{background:#f8fafc}</style>
</head>
<body>
  <div id="root"></div>
  <script>
    const { h, render } = preact;
    const html = htm.bind(h);
    const LS_KEY = "menu_engineer_pro_v1_nobabel";
    function uid(){ try { return crypto.randomUUID(); } catch { return Math.random().toString(36).slice(2); } }
    function currency(n){ if(n==null||isNaN(n)) return "-"; try { return new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(n);} catch { return "$"+Number(n).toFixed(2);} }
    function median(arr){ const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2; }
    function downloadText(filename, text){ const blob=new Blob([text],{type:"text/plain;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500); }
    function escapeCSV(s){ const v=String(s).replace(/"/g,'""'); return /[",\n]/.test(v)?`"${v}"`:v; }
    function splitCSVLine(line){ const out=[]; let cur=""; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch=='"'){ if(inQ && line[i+1]=='"'){cur+='"';i++;} else {inQ=!inQ;} } else if(ch==',' && !inQ){ out.push(cur); cur=""; } else { cur+=ch; } } out.push(cur); return out.map(s=>s.trim()); }
    function parseCSV(text){ const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; const headers=lines[0].split(",").map(h=>h.trim()); return lines.slice(1).map(line=>{ const cols=splitCSVLine(line); const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]); return obj; }); }

    function computeMetrics(items, thresholds){
      const sales = items.map(i=>Number(i.sold)||0);
      const margins = items.map(i=>(Number(i.price)||0)-(Number(i.cost)||0));
      const popularityAvg = sales.reduce((a,b)=>a+b,0)/(sales.length||1);
      const popularityMedian = median(sales);
      const marginAvg = margins.reduce((a,b)=>a+b,0)/(margins.length||1);
      const marginMedian = median(margins);
      const popularityThreshold = thresholds.popularity==="median" ? popularityMedian : popularityAvg;
      const marginThreshold = thresholds.margin==="median" ? marginMedian : marginAvg;
      return { popularityAvg, popularityMedian, marginAvg, marginMedian, popularityThreshold, marginThreshold };
    }
    function classify(item, metrics){
      const sold = Number(item.sold)||0;
      const margin = (Number(item.price)||0)-(Number(item.cost)||0);
      const popHigh = sold>=metrics.popularityThreshold;
      const marHigh = margin>=metrics.marginThreshold;
      if(popHigh&&marHigh) return "star";
      if(popHigh&&!marHigh) return "plow";
      if(!popHigh&&marHigh) return "puzzle";
      return "dog";
    }
    function labelFor(cls){ return cls==="star"?"Estrella":cls==="plow"?"Caballo":cls==="puzzle"?"Puzzle":"Perro"; }
    function badgeClass(cls){ switch(cls){ case "star": return "bg-emerald-100 text-emerald-700 border border-emerald-200"; case "plow": return "bg-amber-100 text-amber-700 border border-amber-200"; case "puzzle": return "bg-sky-100 text-sky-700 border border-sky-200"; case "dog": return "bg-rose-100 text-rose-700 border border-rose-200"; default: return "bg-slate-100 text-slate-700 border"; } }

    const { useState, useMemo, useEffect } = preactHooks;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/preact@10.19.6/hooks.umd.js"></script>
  <script>
    function usePersistentState(defaultState){
      const [state, setState] = preactHooks.useState(()=>{
        try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):defaultState; }catch{ return defaultState; }
      });
      preactHooks.useEffect(()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }, [state]);
      return [state, setState];
    }

    function App(){
      const [db, setDb] = usePersistentState({
        items: [
          { id: uid(), name: "Margarita Clásica", price: 8.5, cost: 2.2, sold: 180 },
          { id: uid(), name: "Old Fashioned", price: 10, cost: 2.5, sold: 120 },
          { id: uid(), name: "Mojito", price: 7.5, cost: 2.0, sold: 200 },
          { id: uid(), name: "Negroni", price: 9.5, cost: 2.8, sold: 90 },
        ],
        thresholds: { popularity: "avg", margin: "avg" },
        activeTab: "table",
      });

      const metrics = preactHooks.useMemo(()=>computeMetrics(db.items, db.thresholds), [db.items, db.thresholds]);

      function handleCSVImport(file){
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const rows = parseCSV(reader.result);
            const items = rows.map(r=>({
              id: uid(),
              name: r.name || r.Nombre || r.Item || "",
              price: Number(r.price ?? r.Precio ?? r.Price ?? 0),
              cost: Number(r.cost ?? r.Costo ?? r.Cost ?? 0),
              sold: Number(r.sold ?? r.Ventas ?? r.Sold ?? 0),
            })).filter(x=>x.name);
            if(!items.length) return alert("CSV sin columnas válidas. Encabezados: name, price, cost, sold");
            setDb(s=>({...s, items}));
          } catch { alert("No se pudo leer el CSV."); }
        };
        reader.readAsText(file);
      }
      function handleCSVExport(){
        const header = "name,price,cost,sold,margin,contribution\n";
        const lines = db.items.map(i=>{
          const m=(i.price||0)-(i.cost||0);
          const c=m*(i.sold||0);
          return `${escapeCSV(i.name)},${i.price||0},${i.cost||0},${i.sold||0},${m.toFixed(2)},${c.toFixed(2)}`;
        }).join("\n");
        downloadText("menu-engineer-data.csv", header+lines);
      }

      return html`
        <div class="min-h-screen">
          <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">ME</div>
                <div>
                  <h1 class="text-xl font-semibold leading-tight">Menu Engineer Pro</h1>
                  <p class="text-xs text-slate-500 -mt-0.5">Clasifica ítems y optimiza rentabilidad</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <label class="px-3 py-1.5 text-sm rounded-xl bg-slate-100 hover:bg-slate-200 cursor-pointer">
                  Importar CSV
                  <input type="file" accept=".csv,text/csv" class="hidden" onChange=${e=>e.target.files&&e.target.files[0]&&handleCSVImport(e.target.files[0])} />
                </label>
                <button onClick=${handleCSVExport} class="px-3 py-1.5 text-sm rounded-xl bg-slate-100 border">Exportar CSV</button>
              </div>
            </div>
            <nav class="max-w-6xl mx-auto px-2 pb-2 overflow-x-auto">
              <div class="flex gap-2">
                ${["table","matrix","insights","help"].map(t => html`
                  <button class=${`px-3 py-2 rounded-xl text-sm whitespace-nowrap border ${db.activeTab===t?"bg-slate-900 text-white border-slate-900":"bg-white hover:bg-slate-100 border-slate-200"}`} onClick=${()=>setDb(s=>({...s, activeTab: t}))}>
                    ${t==="table"?"Tabla":t==="matrix"?"Matriz":t==="insights"?"Insights":"Ayuda"}
                  </button>
                `)}
              </div>
            </nav>
          </header>

          <main class="max-w-6xl mx-auto p-4">
            ${db.activeTab==="table" && html`<${ItemsTable} db=${db} setDb=${setDb} metrics=${metrics} />`}
            ${db.activeTab==="matrix" && html`<${MatrixView} db=${db} metrics=${metrics} />`}
            ${db.activeTab==="insights" && html`<${Insights} metrics=${metrics} />`}
            ${db.activeTab==="help" && html`<${Help} />`}
          </main>

          <footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
            <div class="mt-6 border-t pt-3">Hecho con ❤️ por Digital Drinks Consulting. Datos guardados en tu navegador.</div>
          </footer>
        </div>
      `;
    }

    function ItemsTable({ db, setDb, metrics }){
      function addItem(){ setDb(s=>({...s, items:[...s.items, {id:uid(), name:"Nuevo ítem", price:0, cost:0, sold:0}]})); }
      function setItem(id, patch){ setDb(s=>({...s, items: s.items.map(i=>i.id===id?{...i, ...patch}:i)})); }
      function removeItem(id){ setDb(s=>({...s, items: s.items.filter(i=>i.id!==id)})); }
      function setThresholds(field, val){ setDb(s=>({...s, thresholds:{...s.thresholds, [field]: val}})); }

      return html`
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div><h2 class="text-lg font-semibold">Tabla de ítems</h2><p class="text-sm text-slate-500">Edita Precio, Costo y Ventas. Calcula Margen, Contribución y Clasificación.</p></div>
            <button onClick=${addItem} class="px-3 py-1.5 text-sm rounded-lg bg-slate-900 text-white">Añadir ítem</button>
          </div>
          <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
            <div class="flex items-center gap-2"><span class="text-slate-500">Umbral popularidad:</span>
              <select value=${db.thresholds.popularity} onChange=${e=>setThresholds("popularity", e.target.value)} class="border rounded px-2 py-1">
                <option value="avg">Promedio</option><option value="median">Mediana</option>
              </select>
            </div>
            <div class="flex items-center gap-2"><span class="text-slate-500">Umbral margen:</span>
              <select value=${db.thresholds.margin} onChange=${e=>setThresholds("margin", e.target.value)} class="border rounded px-2 py-1">
                <option value="avg">Promedio</option><option value="median">Mediana</option>
              </select>
            </div>
            <div class="text-slate-500">Popularidad umbral: <strong>${metrics.popularityThreshold.toFixed(1)}</strong> | Margen umbral: <strong>${currency(metrics.marginThreshold)}</strong></div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="text-left text-slate-500"><th class="py-1">Ítem</th><th class="py-1">Precio</th><th class="py-1">Costo</th><th class="py-1">Ventas</th><th class="py-1">Margen</th><th class="py-1">Contribución</th><th class="py-1">Clasificación</th><th class="py-1 w-24">Acciones</th></tr></thead>
              <tbody>
                ${db.items.map(i=>{
                  const margin=(Number(i.price)||0)-(Number(i.cost)||0);
                  const contrib=margin*(Number(i.sold)||0);
                  const cls=classify(i, metrics);
                  return html`<tr class="border-t">
                    <td class="py-1 pr-2"><input value=${i.name} onInput=${e=>setItem(i.id,{name:e.target.value})} class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
                    <td class="py-1 pr-2 w-28"><input type="number" step="0.01" value=${i.price} onInput=${e=>setItem(i.id,{price:Number(e.target.value)})} class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
                    <td class="py-1 pr-2 w-28"><input type="number" step="0.01" value=${i.cost} onInput=${e=>setItem(i.id,{cost:Number(e.target.value)})} class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
                    <td class="py-1 pr-2 w-24"><input type="number" value=${i.sold} onInput=${e=>setItem(i.id,{sold:Number(e.target.value)})} class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
                    <td class="py-1 pr-2">${currency(margin)}</td>
                    <td class="py-1 pr-2">${currency(contrib)}</td>
                    <td class="py-1 pr-2"><span class=${`px-2 py-0.5 rounded text-xs ${badgeClass(cls)}`}>${labelFor(cls)}</span></td>
                    <td class="py-1 w-24"><button onClick=${()=>removeItem(i.id)} class="text-rose-600 hover:underline">Eliminar</button></td>
                  </tr>`;
                })}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    function MatrixView({ db, metrics }){
      const points = db.items.map(i=>{
        const margin=(Number(i.price)||0)-(Number(i.cost)||0);
        const x=margin, y=Number(i.sold)||0, cls=classify(i, metrics);
        return { id:i.id, name:i.name, x, y, cls };
      });
      const xs = points.map(p=>p.x), ys = points.map(p=>p.y);
      const minX = Math.min(...xs, 0), maxX = Math.max(...xs, 1);
      const minY = Math.min(...ys, 0), maxY = Math.max(...ys, 1);
      const scale = (v, mi, ma)=> ma===mi?50:((v-mi)/(ma-mi))*100;

      return html`
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
          <div class="mb-3"><h2 class="text-lg font-semibold">Matriz de Menu Engineering</h2><p class="text-sm text-slate-500">Ejes: Popularidad (Ventas) y Margen por ítem</p></div>
          <div class="relative border rounded-xl bg-slate-50" style="height:420px">
            <div class="absolute inset-0">
              <div class="absolute left-0 right-0 border-t border-dashed border-slate-300" style=${`top:${100 - scale(metrics.popularityThreshold, minY, maxY)}%`}></div>
              <div class="absolute top-0 bottom-0 border-l border-dashed border-slate-300" style=${`left:${scale(metrics.marginThreshold, minX, maxX)}%`}></div>
            </div>
            <div class="absolute top-2 left-2 text-xs bg-white/80 rounded px-1.5 py-0.5">↑ Popularidad</div>
            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs bg-white/80 rounded px-1.5 py-0.5">Margen →</div>
            ${points.map(p=> html`<div class=${`absolute px-2 py-1 rounded text-xs shadow ${badgeClass(p.cls)}`}
                 style=${`left:calc(${scale(p.x, minX, maxX)}% - 24px); top:calc(${100 - scale(p.y, minY, maxY)}% - 12px)`}
                 title=${`${p.name} — Ventas: ${p.y}, Margen: ${currency(p.x)}`}>
              ${p.name}
            </div>`)}
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 text-xs">
            ${html`<${Legend} badge="star" text="Estrella (↑ popularidad, ↑ margen)" />`}
            ${html`<${Legend} badge="plow" text="Caballo (↑ popularidad, ↓ margen)" />`}
            ${html`<${Legend} badge="puzzle" text="Puzzle (↓ popularidad, ↑ margen)" />`}
            ${html`<${Legend} badge="dog" text="Perro (↓ popularidad, ↓ margen)" />`}
          </div>
        </section>
      `;
    }

    function Insights({ metrics }){
      return html`
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
          <h2 class="text-lg font-semibold mb-2">Insights & Recomendaciones</h2>
          <ul class="list-disc pl-5 space-y-1 text-sm">
            <li><strong>Estrellas</strong>: Mantén calidad y promoción discreta.</li>
            <li><strong>Caballos</strong>: Optimiza costo (mermas/proveedores) o ajusta precio leve.</li>
            <li><strong>Puzzles</strong>: Rentables pero poco vendidos; trabaja visibilidad, combos u ofertas.</li>
            <li><strong>Perros</strong>: Replantea receta, precio o retíralos gradualmente.</li>
          </ul>
          <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
            ${html`<${Stat} label="Promedio de popularidad (ventas)" value=${metrics.popularityAvg.toFixed(1)} />`}
            ${html`<${Stat} label="Mediana de popularidad" value=${metrics.popularityMedian.toFixed(1)} />`}
            ${html`<${Stat} label="Margen promedio por ítem" value=${currency(metrics.marginAvg)} />`}
            ${html`<${Stat} label="Margen mediano por ítem" value=${currency(metrics.marginMedian)} />`}
          </div>
        </section>
      `;
    }

    function Help(){
      return html`
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
          <h2 class="text-lg font-semibold mb-2">Cómo usar la app</h2>
          <ol class="list-decimal pl-5 space-y-2 text-sm">
            <li>En <strong>Tabla</strong>, edita <em>Precio</em>, <em>Costo</em> y <em>Ventas</em>. Se calcula <em>Margen</em>, <em>Contribución</em> y <em>Clasificación</em>.</li>
            <li>Elige si los umbrales usan <em>promedio</em> o <em>mediana</em>.</li>
            <li>La <strong>Matriz</strong> posiciona ítems por popularidad y margen con líneas de umbral.</li>
            <li>Exporta/Importa CSV para trabajar con Excel o Google Sheets.</li>
          </ol>
        </section>
      `;
    }

    function Stat({ label, value }){
      return html`<div class="border rounded-lg p-3 bg-slate-50"><div class="text-xs text-slate-500">${label}</div><div class="text-lg font-semibold">${value}</div></div>`;
    }
    function Legend({ badge, text }){
      return html`<div class="flex items-center gap-2"><span class=${`px-2 py-0.5 rounded text-xs ${badgeClass(badge)}`}>${labelFor(badge)}</span><span class="text-slate-500">${text}</span></div>`;
    }

    render(html`<${App} />`, document.getElementById('root'));
  </script>
</body>
</html>
