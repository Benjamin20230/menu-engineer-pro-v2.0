<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Menu Engineer Pro — Full (Vanilla)</title>
<meta name="description" content="Ingeniería de Menú completa: tabla editable, matriz, fijación de precios y dashboard sin dependencias.">
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb; --text:#0f172a; --primary:#0f172a;
    --emerald-bg:#ecfdf5; --emerald:#065f46; --emerald-b:#a7f3d0;
    --amber-bg:#fffbeb; --amber:#92400e; --amber-b:#fed7aa;
    --sky-bg:#eff6ff; --sky:#1e40af; --sky-b:#bfdbfe;
    --rose-bg:#fff1f2; --rose:#9f1239; --rose-b:#fecdd3;
    --brand:#0f172a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;align-items:center;gap:12px}
  .between{justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;border-radius:14px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:700}
  .btn{background:#111827;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.secondary{background:#fff;color:#111827;border:1px solid var(--line)}
  .btn.ghost{background:transparent;color:#111827;border:1px dashed var(--line)}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:16px 0}
  table{border-collapse:collapse;width:100%}
  th,td{padding:6px;text-align:left;border-top:1px solid var(--line)}
  input[type="number"],input[type="text"],select{
    width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#f1f5f9
  }
  label.small{font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:920px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:720px){.row.wrap{flex-wrap:wrap}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
  .b-star{background:var(--emerald-bg);color:var(--emerald);border:1px solid var(--emerald-b)}
  .b-plow{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-b)}
  .b-puzzle{background:var(--sky-bg);color:var(--sky);border:1px solid var(--sky-b)}
  .b-dog{background:var(--rose-bg);color:var(--rose);border:1px solid var(--rose-b)}
  .matrix{position:relative;height:420px;border:1px solid var(--line);border-radius:14px;background:#f1f5f9;overflow:hidden}
  .matrix .line-h{position:absolute;left:0;right:0;border-top:1px dashed #cbd5e1}
  .matrix .line-v{position:absolute;top:0;bottom:0;border-left:1px dashed #cbd5e1}
  .tag{position:absolute;font-size:12px;padding:4px 8px;border-radius:10px;border:1px solid var(--line);background:#fff}
  .kpi{border:1px solid var(--line);border-radius:14px;background:#f8fafc;padding:12px}
  .kpi .v{font-size:18px;font-weight:700}
  .warn{color:#b45309}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="row between wrap">
      <div class="brand">
        <div class="logo">ME</div>
        <div>
          <div style="font-weight:600">Menu Engineer Pro</div>
          <div style="font-size:12px;color:var(--muted);margin-top:-2px">Tabla, Matriz, Precios y Dashboard</div>
        </div>
      </div>
      <div class="row" style="gap:8px">
        <label class="btn secondary">
          Importar CSV
          <input id="fileCSV" type="file" accept=".csv,text/csv" style="display:none">
        </label>
        <label class="btn secondary">
          Importar JSON
          <input id="fileJSON" type="file" accept="application/json" style="display:none">
        </label>
        <button id="btnCSV" class="btn secondary">Exportar CSV</button>
        <button id="btnJSON" class="btn">Exportar JSON</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px; overflow:auto">
      <div class="row" style="gap:8px">
        <button data-tab="table" class="btn secondary tab">Tabla</button>
        <button data-tab="matrix" class="btn secondary tab">Matriz</button>
        <button data-tab="pricing" class="btn secondary tab">Precios</button>
        <button data-tab="dashboard" class="btn secondary tab">Dashboard</button>
        <button data-tab="help" class="btn secondary tab">Ayuda</button>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- TABLA -->
  <section id="view-table" class="card" hidden>
    <div class="row between">
      <div>
        <div style="font-weight:600">Tabla de ítems</div>
        <div style="font-size:13px;color:var(--muted)">Edita Precio, Costo y Ventas. Calcula Margen/Contribución/Clasificación (sin perder foco).</div>
      </div>
      <button id="addItem" class="btn">Añadir ítem</button>
    </div>

    <div class="row wrap" style="gap:12px; margin:12px 0">
      <div class="row" style="gap:8px">
        <span style="color:var(--muted); font-size:14px">Umbral popularidad:</span>
        <select id="thr-pop">
          <option value="avg">Promedio</option>
          <option value="median">Mediana</option>
        </select>
      </div>
      <div class="row" style="gap:8px">
        <span style="color:var(--muted); font-size:14px">Umbral margen:</span>
        <select id="thr-mar">
          <option value="avg">Promedio</option>
          <option value="median">Mediana</option>
        </select>
      </div>
      <div id="thr-info" style="color:var(--muted); font-size:14px"></div>
    </div>

    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr style="color:var(--muted)">
            <th>Ítem</th><th>Precio</th><th>Costo</th><th>Ventas</th>
            <th>Margen</th><th>Contribución</th><th>Clasificación</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- MATRIZ -->
  <section id="view-matrix" class="card" hidden>
    <div style="font-weight:600; margin-bottom:8px">Matriz de Menu Engineering</div>
    <div class="matrix" id="matrix"></div>
    <div class="grid grid-4" style="margin-top:12px; font-size:13px; color:var(--muted)">
      <div><span class="chip b-star">Estrella</span> (↑ popularidad, ↑ margen)</div>
      <div><span class="chip b-plow">Caballo</span> (↑ popularidad, ↓ margen)</div>
      <div><span class="chip b-puzzle">Puzzle</span> (↓ popularidad, ↑ margen)</div>
      <div><span class="chip b-dog">Perro</span> (↓ popularidad, ↓ margen)</div>
    </div>
  </section>

  <!-- PRECIOS -->
  <section id="view-pricing" class="card" hidden>
    <div class="row between wrap">
      <div>
        <div style="font-weight:600">Fijación de precios</div>
        <div style="font-size:13px;color:var(--muted)">Define parámetros y obtén precio sugerido por ítem según % de costo objetivo.</div>
      </div>
      <button id="applyAll" class="btn ghost">Aplicar sugerido a TODOS</button>
    </div>

    <div class="grid grid-4" style="margin-top:10px">
      <div>
        <label class="small">% costo objetivo (Food Cost)</label>
        <input id="cfg-foodcost" type="number" step="0.5" value="25" />
      </div>
      <div>
        <label class="small">IVA/ITBMS % (opcional)</label>
        <input id="cfg-tax" type="number" step="0.5" value="0" />
      </div>
      <div>
        <label class="small">Redondeo (p.ej. 0.05, 0.10, 0.25, 0.50, 1.00)</label>
        <input id="cfg-round" type="number" step="0.01" value="0.10" />
      </div>
      <div>
        <label class="small">Precio mínimo (opcional)</label>
        <input id="cfg-minprice" type="number" step="0.01" value="0" />
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:600; margin-bottom:8px">Sugerencias por ítem</div>
      <div style="overflow:auto">
        <table id="tbl-pricing">
          <thead>
            <tr style="color:var(--muted)">
              <th>Ítem</th><th>Precio actual</th><th>Costo</th><th>% Costo</th>
              <th>Precio sugerido</th><th>Margen sugerido</th><th>Contribución (sugerido)</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px;color:#92400e;font-size:12px">
        <span class="warn">Nota:</span> Fórmula sugerida (sin IVA): <code>precio = costo / (foodcost%/100)</code>.  
        Si usas IVA, el precio final incluirá el IVA (opción para carta “IVA incluido”). Redondeo aplicado al final.
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="view-dashboard" class="card" hidden>
    <div style="font-weight:600">Dashboard</div>
    <div class="grid grid-4" style="margin-top:10px">
      <div class="kpi"><div class="small">Ingresos estimados</div><div class="v" id="kpi-revenue">$0</div></div>
      <div class="kpi"><div class="small">Contribución total</div><div class="v" id="kpi-contrib">$0</div></div>
      <div class="kpi"><div class="small">Margen promedio</div><div class="v" id="kpi-margin">$0</div></div>
      <div class="kpi"><div class="small">Mix (ítems)</div><div class="v" id="kpi-count">0</div></div>
    </div>
    <div class="grid grid-2" style="margin-top:12px">
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Ventas por ítem</div>
        <canvas id="chart-sales" width="500" height="250"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Contribución por ítem</div>
        <canvas id="chart-contrib" width="500" height="250"></canvas>
      </div>
    </div>
  </section>

  <!-- AYUDA -->
  <section id="view-help" class="card" hidden>
    <div style="font-weight:600; margin-bottom:8px">Cómo usar la app</div>
    <ol style="margin:0 0 8px 18px; padding:0; font-size:14px">
      <li>En <b>Tabla</b>, edita <i>Precio</i>, <i>Costo</i> y <i>Ventas</i>. Se calcula <i>Margen</i>, <i>Contribución</i> y <i>Clasificación</i>.</li>
      <li>En <b>Matriz</b>, ubica cada ítem por popularidad (ventas) y margen, con líneas de umbral (promedio/mediana).</li>
      <li>En <b>Precios</b>, define parámetros y aplica el precio sugerido por ítem o masivo.</li>
      <li>En <b>Dashboard</b>, observa KPIs y gráficos de ventas/contribución.</li>
      <li>Importa/Exporta CSV/JSON para respaldo o edición en Excel/Sheets.</li>
    </ol>
  </section>

</main>

<script>
/* ================== UTILIDADES Y ESTADO ================== */
const LS_KEY = "menu_engineer_full_v1";
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const currency = n => isNaN(n) ? '-' : new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(n);
const median = arr => { const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2; };
const uid = () => Math.random().toString(36).slice(2);
const escapeCSV = s => { const v=String(s).replace(/"/g,'""'); return /[",\n]/.test(v)?`"${v}"`:v; };
function splitCSVLine(line){ const out=[]; let cur=""; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i];
  if(ch=='"'){ if(inQ && line[i+1]=='"'){cur+='"';i++;} else {inQ=!inQ;} }
  else if(ch==',' && !inQ){ out.push(cur); cur=""; }
  else { cur+=ch; } }
  out.push(cur); return out.map(s=>s.trim()); }
function parseCSV(text){ const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; const headers=lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).map(line=>{ const cols=splitCSVLine(line); const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]); return obj; }); }
function downloadText(filename, text){ const blob=new Blob([text], {type:"text/plain;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }
function debounce(fn, wait=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

const state = (() => {
  try { const raw = localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw); } catch {}
  return {
    items: [
      { id: uid(), name: "Margarita Clásica", price: 8.5, cost: 2.2, sold: 180 },
      { id: uid(), name: "Old Fashioned",   price:10.0, cost: 2.5, sold: 120 },
      { id: uid(), name: "Mojito",          price: 7.5, cost: 2.0, sold: 200 },
      { id: uid(), name: "Negroni",         price: 9.5, cost: 2.8, sold: 90  },
    ],
    thresholds: { popularity: "avg", margin: "avg" },
    active: "table",
    pricing: { foodCostPct: 25, taxPct: 0, roundStep: 0.10, minPrice: 0 }
  };
})();
function save(){ try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {} }

/* ================== CÁLCULOS BÁSICOS ================== */
function metricsCalc(){
  const sales = state.items.map(i => +i.sold||0);
  const margins = state.items.map(i => (+i.price||0) - (+i.cost||0));
  const popularityAvg = sales.reduce((a,b)=>a+b,0) / (sales.length || 1);
  const marginAvg = margins.reduce((a,b)=>a+b,0) / (margins.length || 1);
  const popularityMedian = median(sales);
  const marginMedian = median(margins);
  const popularityThreshold = state.thresholds.popularity === "median" ? popularityMedian : popularityAvg;
  const marginThreshold = state.thresholds.margin === "median" ? marginMedian : marginAvg;
  return { popularityAvg, marginAvg, popularityMedian, marginMedian, popularityThreshold, marginThreshold };
}
function classify(item, m){
  const sold = +item.sold||0;
  const margin = (+item.price||0) - (+item.cost||0);
  const popHigh = sold >= m.popularityThreshold;
  const marHigh = margin >= m.marginThreshold;
  if (popHigh && marHigh) return "star";
  if (popHigh && !marHigh) return "plow";
  if (!popHigh && marHigh) return "puzzle";
  return "dog";
}
function labelFor(cls){ return cls==="star"?"Estrella":cls==="plow"?"Caballo":cls==="puzzle"?"Puzzle":"Perro"; }
function badgeClass(cls){ return cls==="star"?"chip b-star":cls==="plow"?"chip b-plow":cls==="puzzle"?"chip b-puzzle":"chip b-dog"; }

/* ================== TABS ================== */
function showTab(){
  $("#view-table").hidden     = state.active!=="table";
  $("#view-matrix").hidden    = state.active!=="matrix";
  $("#view-pricing").hidden   = state.active!=="pricing";
  $("#view-dashboard").hidden = state.active!=="dashboard";
  $("#view-help").hidden      = state.active!=="help";

  if (state.active==="table") renderTable();
  if (state.active==="matrix") renderMatrix();
  if (state.active==="pricing") renderPricing();
  if (state.active==="dashboard") renderDashboard();
}
$$(".tab").forEach(b=>{
  b.onclick = ()=>{ state.active=b.dataset.tab; save(); showTab(); };
});

/* ================== TABLA (sin perder foco) ================== */
function renderTable(){
  const m = metricsCalc();
  $("#thr-pop").value = state.thresholds.popularity;
  $("#thr-mar").value = state.thresholds.margin;
  const setThrInfo = (mm)=> $("#thr-info").innerHTML =
    `Popularidad umbral: <b>${mm.popularityThreshold.toFixed(1)}</b> | Margen umbral: <b>${currency(mm.marginThreshold)}</b>`;
  setThrInfo(m);

  $("#thr-pop").onchange = e => { state.thresholds.popularity = e.target.value; save(); fullRecalc(); };
  $("#thr-mar").onchange = e => { state.thresholds.margin = e.target.value; save(); fullRecalc(); };

  const tbody = $("#tbl tbody");
  tbody.innerHTML = "";

  function updateRow(tr, item, mm){
    const margin = (+item.price||0) - (+item.cost||0);
    const contrib = margin * (+item.sold||0);
    const cls = classify(item, mm);
    tr.querySelector('[data-cell="margin"]').textContent = currency(margin);
    tr.querySelector('[data-cell="contrib"]').textContent = currency(contrib);
    const badge = tr.querySelector('[data-cell="class"]');
    badge.className = badgeClass(cls);
    badge.textContent = labelFor(cls);
  }
  const fullRecalc = debounce(() => {
    const mm = metricsCalc();
    setThrInfo(mm);
    [...tbody.children].forEach((tr, idx) => updateRow(tr, state.items[idx], mm));
    save();
  }, 200);

  state.items.forEach((i, idx) => {
    const tr = document.createElement("tr");
    const margin = (+i.price||0) - (+i.cost||0);
    const contrib = margin * (+i.sold||0);
    const cls = classify(i, m);

    tr.innerHTML = `
      <td><input data-edit="name"  value="${i.name}"/></td>
      <td><input data-edit="price" type="number" step="0.01" value="${i.price}"/></td>
      <td><input data-edit="cost"  type="number" step="0.01" value="${i.cost}"/></td>
      <td><input data-edit="sold"  type="number" value="${i.sold}"/></td>
      <td data-cell="margin">${currency(margin)}</td>
      <td data-cell="contrib">${currency(contrib)}</td>
      <td><span data-cell="class" class="${badgeClass(cls)}">${labelFor(cls)}</span></td>
      <td><button class="btn secondary btn-del" style="padding:4px 8px">Eliminar</button></td>
    `;

    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input",(e)=>{
        const k = e.target.getAttribute("data-edit");
        const raw = e.target.value;
        const val = (k==="price"||k==="cost"||k==="sold") ? (raw===""? "" : +raw) : raw;
        state.items[idx] = { ...state.items[idx], [k]: val };
        const safe = {
          ...state.items[idx],
          price:+state.items[idx].price||0,
          cost:+state.items[idx].cost||0,
          sold:+state.items[idx].sold||0,
        };
        updateRow(tr, safe, metricsCalc());
        save();
        fullRecalc();
      }, {passive:true});
    });
    tr.querySelector(".btn-del").onclick = ()=>{ state.items.splice(idx,1); save(); renderTable(); };
    tbody.appendChild(tr);
  });

  $("#addItem").onclick = ()=>{ state.items.push({ id:uid(), name:"Nuevo ítem", price:0, cost:0, sold:0 }); save(); renderTable(); };
}

/* ================== MATRIZ ================== */
function renderMatrix(){
  const m = metricsCalc();
  const box = $("#matrix");
  box.innerHTML = "";
  const pts = state.items.map(i=>{
    const margin = (+i.price||0) - (+i.cost||0);
    const x=margin, y=(+i.sold||0), cls=classify(i,m);
    return {name:i.name, x, y, cls};
  });
  const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
  const minX = Math.min(...xs, 0), maxX = Math.max(...xs, 1);
  const minY = Math.min(...ys, 0), maxY = Math.max(...ys, 1);
  const sc = (v, mi, ma)=> ma===mi?50:((v-mi)/(ma-mi))*100;

  const h = document.createElement("div"); h.className="line-h"; h.style.top = `${100 - sc(m.popularityThreshold, minY, maxY)}%`; box.appendChild(h);
  const v = document.createElement("div"); v.className="line-v"; v.style.left = `${sc(m.marginThreshold, minX, maxX)}%`; box.appendChild(v);
  const t1 = document.createElement("div"); t1.className="tag"; t1.style.top="6px"; t1.style.left="6px"; t1.textContent="↑ Popularidad"; box.appendChild(t1);
  const t2 = document.createElement("div"); t2.className="tag"; t2.style.bottom="6px"; t2.style.left="50%"; t2.style.transform="translateX(-50%)"; t2.textContent="Margen →"; box.appendChild(t2);

  pts.forEach(p=>{
    const el = document.createElement("div");
    const c = p.cls==="star"?"b-star":p.cls==="plow"?"b-plow":p.cls==="puzzle"?"b-puzzle":"b-dog";
    el.className = `tag ${c}`;
    el.style.left = `calc(${sc(p.x, minX, maxX)}% - 24px)`;
    el.style.top  = `calc(${100 - sc(p.y, minY, maxY)}% - 12px)`;
    el.title = `${p.name} — Ventas: ${p.y}, Margen: ${currency(p.x)}`;
    el.textContent = p.name;
    box.appendChild(el);
  });
}

/* ================== PRECIO SUGERIDO ================== */
function roundToStep(value, step){
  if(step<=0) return value;
  const m = Math.round(value / step) * step;
  return Math.round(m*100)/100;
}
function suggestedPrice(cost, foodCostPct, taxPct, roundStep, minPrice){
  cost = +cost||0;
  const f = (foodCostPct>0) ? (foodCostPct/100) : 0.25; // fallback 25%
  let p = (f>0) ? cost / f : cost * 4; // si f=0, multiplicador grande (fallback)
  if (taxPct>0){
    // devolver precio "IVA incluido": p_final = p * (1 + IVA)
    p = p * (1 + (taxPct/100));
  }
  if (minPrice>0 && p < minPrice) p = minPrice;
  if (roundStep>0) p = roundToStep(p, roundStep);
  return Math.max(0, Math.round(p*100)/100);
}
function renderPricing(){
  // Cargar config
  $("#cfg-foodcost").value = state.pricing.foodCostPct;
  $("#cfg-tax").value = state.pricing.taxPct;
  $("#cfg-round").value = state.pricing.roundStep;
  $("#cfg-minprice").value = state.pricing.minPrice;

  const syncCfg = ()=>{
    state.pricing.foodCostPct = +$("#cfg-foodcost").value || 0;
    state.pricing.taxPct      = +$("#cfg-tax").value || 0;
    state.pricing.roundStep   = +$("#cfg-round").value || 0;
    state.pricing.minPrice    = +$("#cfg-minprice").value || 0;
    save();
    renderPricingTable();
  };
  ["cfg-foodcost","cfg-tax","cfg-round","cfg-minprice"].forEach(id=>{
    $("#"+id).oninput = debounce(syncCfg, 150);
  });

  function renderPricingTable(){
    const tb = $("#tbl-pricing tbody");
    tb.innerHTML = "";
    const cfg = state.pricing;

    state.items.forEach((it, idx)=>{
      const cost = +it.cost||0, price= +it.price||0, sold = +it.sold||0;
      const sugg = suggestedPrice(cost, cfg.foodCostPct, cfg.taxPct, cfg.roundStep, cfg.minPrice);
      const marginS = sugg - cost;
      const contribS = marginS * sold;
      const pctCostActual = price>0 ? (cost/price)*100 : 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${currency(price)}</td>
        <td>${currency(cost)}</td>
        <td>${pctCostActual ? pctCostActual.toFixed(1)+'%' : '-'}</td>
        <td><b>${currency(sugg)}</b></td>
        <td>${currency(marginS)}</td>
        <td>${currency(contribS)}</td>
        <td><button class="btn secondary btn-apply" style="padding:4px 8px">Aplicar</button></td>
      `;
      tr.querySelector(".btn-apply").onclick = ()=>{
        state.items[idx].price = sugg;
        save();
        // refrescar todo lo que depende de precios
        renderPricingTable();
        renderTable();
        renderDashboard();
      };
      tb.appendChild(tr);
    });
  }

  $("#applyAll").onclick = ()=>{
    const cfg = state.pricing;
    state.items = state.items.map(it=>{
      const cost = +it.cost||0;
      const sugg = suggestedPrice(cost, cfg.foodCostPct, cfg.taxPct, cfg.roundStep, cfg.minPrice);
      return { ...it, price: sugg };
    });
    save();
    renderPricingTable();
    renderTable();
    renderDashboard();
  };

  renderPricingTable();
}

/* ================== DASHBOARD ================== */
function renderDashboard(){
  const items = state.items.map(i=>({
    ...i,
    price:+i.price||0, cost:+i.cost||0, sold:+i.sold||0
  }));
  const revenue = items.reduce((s,i)=> s + (i.price*i.sold), 0);
  const contrib = items.reduce((s,i)=> s + ((i.price-i.cost)*i.sold), 0);
  const marginAvg = items.reduce((s,i)=> s + (i.price-i.cost), 0) / (items.length||1);

  $("#kpi-revenue").textContent = currency(revenue);
  $("#kpi-contrib").textContent = currency(contrib);
  $("#kpi-margin").textContent  = currency(marginAvg);
  $("#kpi-count").textContent   = items.length;

  drawBarChart($("#chart-sales"), items.map(i=>i.name), items.map(i=>i.sold), "Ventas (unidades)");
  drawBarChart($("#chart-contrib"), items.map(i=>i.name), items.map(i=>(i.price-i.cost)*i.sold), "Contribución ($)");
}
function drawBarChart(canvas, labels, values, title){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  // bordes
  ctx.fillStyle = "#111827"; ctx.font = "bold 14px system-ui, Arial";
  ctx.fillText(title, 10, 18);
  // área
  const left=50, right=W-10, top=30, bottom=H-30;
  // ejes
  ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, bottom); ctx.lineTo(right, bottom); ctx.stroke();
  const maxVal = Math.max(1, ...values);
  const barW = (right-left) / (labels.length || 1) * 0.7;
  values.forEach((v, i)=>{
    const x = left + ((i+0.15) * (right-left)/(labels.length||1));
    const h = (v/maxVal)*(bottom-top);
    const y = bottom - h;
    ctx.fillStyle = "#111827";
    ctx.fillRect(x, y, barW, h);
  });
  // etiquetas (truncadas)
  ctx.fillStyle="#6b7280"; ctx.font="10px system-ui, Arial";
  labels.forEach((lab,i)=>{
    const x = left + ((i+0.5) * (right-left)/(labels.length||1));
    const txt = lab.length>10 ? lab.slice(0,9)+"…" : lab;
    ctx.save();
    ctx.translate(x, bottom+12);
    ctx.rotate(-Math.PI/6);
    ctx.fillText(txt, 0, 0);
    ctx.restore();
  });
}

/* ================== IMPORT/EXPORT ================== */
$("#fileCSV").onchange = e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    try{
      const rows = parseCSV(r.result);
      const items = rows.map(o=>({
        id: uid(),
        name: o.name || o.Nombre || o.Item || "",
        price: Number(o.price ?? o.Precio ?? o.Price ?? 0),
        cost: Number(o.cost ?? o.Costo ?? o.Cost ?? 0),
        sold: Number(o.sold ?? o.Ventas ?? o.Sold ?? 0),
      })).filter(x=>x.name);
      if(!items.length) return alert("CSV sin columnas válidas. Usa encabezados: name, price, cost, sold");
      state.items = items; save(); showTab();
    }catch{ alert("No se pudo leer el CSV."); }
  }; r.readAsText(f);
  e.target.value = "";
};
$("#fileJSON").onchange = e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    try{ const obj = JSON.parse(r.result); if(obj?.items) { Object.assign(state, obj); save(); showTab(); } else { alert("JSON inválido."); } }
    catch{ alert("JSON inválido."); }
  }; r.readAsText(f);
  e.target.value = "";
};
$("#btnCSV").onclick = ()=>{
  const header = "name,price,cost,sold,margin,contribution\n";
  const lines = state.items.map(i=>{
    const p=+i.price||0, c=+i.cost||0, s=+i.sold||0;
    const m = (p - c);
    const contr = m * s;
    return `${escapeCSV(i.name)},${p},${c},${s},${m.toFixed(2)},${contr.toFixed(2)}`;
  }).join("\n");
  downloadText("menu-engineer-data.csv", header+lines);
};
$("#btnJSON").onclick = ()=>{
  downloadText(`menu-engineer-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(state, null, 2));
};

/* ================== INIT ================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // activar tab por defecto visualmente
  document.querySelector(`.tab[data-tab="${state.active}"]`)?.classList.add("active");
  showTab();
});
</script>
</body>
</html>
