<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu Engineer Pro — Digital Drinks (MVP)</title>
  <meta name="description" content="App gratuita para Menu Engineering: clasifica ítems (Estrella, Caballo, Puzzle, Perro) y calcula márgenes y popularidad.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23000000'/><text x='50' y='60' font-size='45' text-anchor='middle' fill='white' font-family='Arial'>ME</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.9/babel.min.js"></script>
  <style>body{background:#f8fafc}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState } = React;
    const LS_KEY = "menu_engineer_pro_v1";
    function uid(){ return (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); }
    function usePersistentState(defaultState) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : defaultState; }
        catch { return defaultState; }
      });
      useEffect(() => { try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch{} }, [state]);
      return [state, setState];
    }
    const currency = (n) => { if (n === undefined || n === null || isNaN(n)) return "-"; try { return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" }).format(n); } catch { return "$" + Number(n).toFixed(2); } };
    function median(arr){ const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2; }
    function downloadText(filename, text){ const blob=new Blob([text], {type:"text/plain;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500); }
    function escapeCSV(s){ const v=String(s).replace(/"/g,'""'); return /[",\n]/.test(v)?`"${v}"`:v; }
    function splitCSVLine(line){ const out=[]; let cur=""; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch === '"'){ if(inQ && line[i+1] === '"'){ cur+='"'; i++; } else { inQ = !inQ; } } else if(ch === ',' && !inQ){ out.push(cur); cur=""; } else { cur += ch; } } out.push(cur); return out.map(s=>s.trim()); }
    function parseCSV(text){ const lines = text.split(/\r?\n/).filter(Boolean); if(!lines.length) return []; const headers = lines[0].split(",").map(h=>h.trim()); return lines.slice(1).map(line => { const cols = splitCSVLine(line); const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]); return obj; }); }
    function computeMetrics(items, thresholds){ const sales = items.map(i => Number(i.sold)||0); const margins = items.map(i => (Number(i.price)||0) - (Number(i.cost)||0)); const popularityAvg = (sales.reduce((a,b)=>a+b,0) / (sales.length || 1)); const popularityMedian = median(sales); const marginAvg = (margins.reduce((a,b)=>a+b,0) / (margins.length || 1)); const marginMedian = median(margins); const popularityThreshold = thresholds.popularity==="median" ? popularityMedian : popularityAvg; const marginThreshold = thresholds.margin==="median" ? marginMedian : marginAvg; return { popularityAvg, popularityMedian, marginAvg, marginMedian, popularityThreshold, marginThreshold }; }
    function classify(item, metrics){ const sold = Number(item.sold)||0; const margin = (Number(item.price)||0) - (Number(item.cost)||0); const popHigh = sold >= metrics.popularityThreshold; const marHigh = margin >= metrics.marginThreshold; if (popHigh && marHigh) return "star"; if (popHigh && !marHigh) return "plow"; if (!popHigh && marHigh) return "puzzle"; return "dog"; }
    function labelFor(cls){ return cls==="star"?"Estrella":cls==="plow"?"Caballo":cls==="puzzle"?"Puzzle":"Perro"; }
    function badgeClass(cls){ switch(cls){ case "star": return "bg-emerald-100 text-emerald-700 border border-emerald-200"; case "plow": return "bg-amber-100 text-amber-700 border border-amber-200"; case "puzzle": return "bg-sky-100 text-sky-700 border border-sky-200"; case "dog": return "bg-rose-100 text-rose-700 border border-rose-200"; default: return "bg-slate-100 text-slate-700 border"; } }
    function App() {
      const [db, setDb] = usePersistentState({ items: [ { id: uid(), name: "Margarita Clásica", price: 8.5, cost: 2.2, sold: 180 }, { id: uid(), name: "Old Fashioned", price: 10, cost: 2.5, sold: 120 }, { id: uid(), name: "Mojito", price: 7.5, cost: 2.0, sold: 200 }, { id: uid(), name: "Negroni", price: 9.5, cost: 2.8, sold: 90 }, ], thresholds: { popularity: "avg", margin: "avg" }, activeTab: "table" });
      const setActive = (t) => setDb(s => ({...s, activeTab: t}));
      const metrics = React.useMemo(() => computeMetrics(db.items, db.thresholds), [db.items, db.thresholds]);
      const handleCSVImport = (file) => { const reader = new FileReader(); reader.onload = () => { try { const rows = parseCSV(reader.result); const items = rows.map(r => ({ id: uid(), name: r.name || r.Nombre || r.Item || "", price: Number(r.price ?? r.Precio ?? r.Price ?? 0), cost: Number(r.cost ?? r.Costo ?? r.Cost ?? 0), sold: Number(r.sold ?? r.Ventas ?? r.Sold ?? 0), })).filter(x => x.name); if (!items.length) return alert("CSV sin columnas válidas. Encabezados: name, price, cost, sold"); setDb(s => ({...s, items})); } catch { alert("No se pudo leer el CSV. Usa columnas: name, price, cost, sold."); } }; reader.readAsText(file); };
      const handleCSVExport = () => { const header = "name,price,cost,sold,margin,contribution\n"; const lines = db.items.map(i => { const m = (i.price || 0) - (i.cost || 0); const c = m * (i.sold || 0); return \`\${escapeCSV(i.name)},\${i.price||0},\${i.cost||0},\${i.sold||0},\${m.toFixed(2)},\${c.toFixed(2)}\`; }).join("\n"); downloadText("menu-engineer-data.csv", header + lines); };
      return (<div className="min-h-screen">
        <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3"><div className="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">ME</div><div><h1 className="text-xl font-semibold leading-tight">Menu Engineer Pro</h1><p className="text-xs text-slate-500 -mt-0.5">Clasifica ítems y optimiza rentabilidad</p></div></div>
            <div className="flex items-center gap-2">
              <label className="px-3 py-1.5 text-sm rounded-xl bg-slate-100 hover:bg-slate-200 cursor-pointer">Importar CSV<input type="file" accept=".csv,text/csv" className="hidden" onChange={(e)=>e.target.files?.[0] && handleCSVImport(e.target.files[0])}/></label>
              <button onClick={handleCSVExport} className="px-3 py-1.5 text-sm rounded-xl bg-slate-100 border">Exportar CSV</button>
            </div>
          </div>
          <nav className="max-w-6xl mx-auto px-2 pb-2 overflow-x-auto">
            <div className="flex gap-2">{["table","matrix","insights","help"].map(t => (<button key={t} onClick={()=>setActive(t)} className={\`px-3 py-2 rounded-xl text-sm whitespace-nowrap border \${db.activeTab===t?"bg-slate-900 text-white border-slate-900":"bg-white hover:bg-slate-100 border-slate-200"}\`}>{t==="table"?"Tabla":t==="matrix"?"Matriz":t==="insights"?"Insights":"Ayuda"}</button>))}</div>
          </nav>
        </header>
        <main className="max-w-6xl mx-auto p-4">
          {db.activeTab==="table" && <ItemsTable db={db} setDb={setDb} metrics={metrics} />}
          {db.activeTab==="matrix" && <MatrixView db={db} metrics={metrics} />}
          {db.activeTab==="insights" && <Insights metrics={metrics} />}
          {db.activeTab==="help" && <Help />}
        </main>
        <footer className="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500"><div className="mt-6 border-t pt-3">Hecho con ❤️ por Digital Drinks Consulting. Datos guardados en tu navegador.</div></footer>
      </div>); }
    function ItemsTable({ db, setDb, metrics }) {
      const addItem = () => setDb(s => ({...s, items: [...s.items, { id: uid(), name: "Nuevo ítem", price: 0, cost: 0, sold: 0 }]}));
      const setItem = (id, patch) => setDb(s => ({...s, items: s.items.map(i => i.id===id ? {...i, ...patch} : i)}));
      const removeItem = (id) => setDb(s => ({...s, items: s.items.filter(i => i.id!==id)}));
      const setThresholds = (field, val) => setDb(s => ({...s, thresholds: {...s.thresholds, [field]: val}}));
      return (<section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
        <div className="flex items-center justify-between mb-3">
          <div><h2 className="text-lg font-semibold">Tabla de ítems</h2><p className="text-sm text-slate-500">Edita Precio, Costo y Ventas. El sistema calcula el Margen, Contribución y la Clasificación.</p></div>
          <button onClick={addItem} className="px-3 py-1.5 text-sm rounded-lg bg-slate-900 text-white">Añadir ítem</button>
        </div>
        <div className="flex flex-wrap items-center gap-3 mb-3 text-sm">
          <div className="flex items-center gap-2"><span className="text-slate-500">Umbral popularidad:</span>
            <select value={db.thresholds.popularity} onChange={e=>setThresholds("popularity", e.target.value)} className="border rounded px-2 py-1"><option value="avg">Promedio</option><option value="median">Mediana</option></select>
          </div>
          <div className="flex items-center gap-2"><span className="text-slate-500">Umbral margen:</span>
            <select value={db.thresholds.margin} onChange={e=>setThresholds("margin", e.target.value)} className="border rounded px-2 py-1"><option value="avg">Promedio</option><option value="median">Mediana</option></select>
          </div>
          <div className="text-slate-500">Popularidad umbral: <strong>{metrics.popularityThreshold.toFixed(1)}</strong> | Margen umbral: <strong>{currency(metrics.marginThreshold)}</strong></div>
        </div>
        <div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="text-left text-slate-500"><th className="py-1">Ítem</th><th className="py-1">Precio</th><th className="py-1">Costo</th><th className="py-1">Ventas</th><th className="py-1">Margen</th><th className="py-1">Contribución</th><th className="py-1">Clasificación</th><th className="py-1 w-24">Acciones</th></tr></thead><tbody>
          {db.items.map(i => { const margin = (Number(i.price)||0) - (Number(i.cost)||0); const contrib = margin * (Number(i.sold)||0); const cls = classify(i, metrics);
            return (<tr key={i.id} className="border-t">
              <td className="py-1 pr-2"><input value={i.name} onChange={e=>setItem(i.id, {name:e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
              <td className="py-1 pr-2 w-28"><input type="number" step="0.01" value={i.price} onChange={e=>setItem(i.id, {price:Number(e.target.value)})} className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
              <td className="py-1 pr-2 w-28"><input type="number" step="0.01" value={i.cost} onChange={e=>setItem(i.id, {cost:Number(e.target.value)})} className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
              <td className="py-1 pr-2 w-24"><input type="number" value={i.sold} onChange={e=>setItem(i.id, {sold:Number(e.target.value)})} className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1"/></td>
              <td className="py-1 pr-2">{currency(margin)}</td><td className="py-1 pr-2">{currency(contrib)}</td>
              <td className="py-1 pr-2"><span className={`px-2 py-0.5 rounded text-xs ${badgeClass(cls)}`}>{labelFor(cls)}</span></td>
              <td className="py-1 w-24"><button onClick={()=>setDb(s=>({...s, items: s.items.filter(x=>x.id!==i.id)}))} className="text-rose-600 hover:underline">Eliminar</button></td>
            </tr>);})}
        </tbody></table></div></section>); }
    function MatrixView({ db, metrics }) {
      const points = db.items.map(i => { const margin = (Number(i.price)||0) - (Number(i.cost)||0); const x = margin, y = Number(i.sold)||0, cls = classify(i, metrics); return { id: i.id, name: i.name, x, y, cls }; });
      const xs = points.map(p => p.x), ys = points.map(p => p.y);
      const minX = Math.min(...xs, 0), maxX = Math.max(...xs, 1);
      const minY = Math.min(...ys, 0), maxY = Math.max(...ys, 1);
      const scale = (v, mi, ma) => ma===mi ? 50 : ((v-mi)/(ma-mi))*100;
      return (<section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
        <div className="mb-3"><h2 className="text-lg font-semibold">Matriz de Menu Engineering</h2><p className="text-sm text-slate-500">Ejes: Popularidad (Ventas) y Margen por ítem</p></div>
        <div className="relative border rounded-xl bg-slate-50" style={{height:'420px'}}>
          <div className="absolute inset-0">
            <div className="absolute left-0 right-0 border-t border-dashed border-slate-300" style={{ top: `${100 - scale(metrics.popularityThreshold, minY, maxY)}%`}}></div>
            <div className="absolute top-0 bottom-0 border-l border-dashed border-slate-300" style={{ left: `${scale(metrics.marginThreshold, minX, maxX)}%`}}></div>
          </div>
          <div className="absolute top-2 left-2 text-xs bg-white/80 rounded px-1.5 py-0.5">↑ Popularidad</div>
          <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs bg-white/80 rounded px-1.5 py-0.5">Margen →</div>
          {points.map(p => (<div key={p.id} className={`absolute px-2 py-1 rounded text-xs shadow ${badgeClass(p.cls)}`}
               style={{ left: `calc(${scale(p.x, minX, maxX)}% - 24px)`, top: `calc(${100 - scale(p.y, minY, maxY)}% - 12px)` }}
               title={`${p.name} — Ventas: ${p.y}, Margen: ${currency(p.x)}`}>
            {p.name}
          </div>))}
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 text-xs">
          <Legend badge="star" text="Estrella (↑ popularidad, ↑ margen)" />
          <Legend badge="plow" text="Caballo (↑ popularidad, ↓ margen)" />
          <Legend badge="puzzle" text="Puzzle (↓ popularidad, ↑ margen)" />
          <Legend badge="dog" text="Perro (↓ popularidad, ↓ margen)" />
        </div>
      </section>); }
    function Insights({ metrics }) {
      return (<section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
        <h2 className="text-lg font-semibold mb-2">Insights & Recomendaciones</h2>
        <ul className="list-disc pl-5 space-y-1 text-sm">
          <li><strong>Estrellas</strong>: Mantén calidad y promoción discreta.</li>
          <li><strong>Caballos</strong>: Optimiza costo (mermas/proveedores) o ajusta precio leve.</li>
          <li><strong>Puzzles</strong>: Rentables pero poco vendidos; trabaja visibilidad, combos u ofertas.</li>
          <li><strong>Perros</strong>: Replantea receta, precio o retíralos gradualmente.</li>
        </ul>
        <div className="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <Stat label="Promedio de popularidad (ventas)" value={metrics.popularityAvg.toFixed(1)} />
          <Stat label="Mediana de popularidad" value={metrics.popularityMedian.toFixed(1)} />
          <Stat label="Margen promedio por ítem" value={currency(metrics.marginAvg)} />
          <Stat label="Margen mediano por ítem" value={currency(metrics.marginMedian)} />
        </div>
      </section>); }
    function Help() {
      return (<section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
        <h2 className="text-lg font-semibold mb-2">Cómo usar la app</h2>
        <ol className="list-decimal pl-5 space-y-2 text-sm">
          <li>En <strong>Tabla</strong>, edita <em>Precio</em>, <em>Costo</em> y <em>Ventas</em>. Se calcula <em>Margen</em>, <em>Contribución</em> y la <em>Clasificación</em>.</li>
          <li>Elige si los umbrales usan <em>promedio</em> o <em>mediana</em> (la mediana es robusta ante outliers).</li>
          <li>La <strong>Matriz</strong> posiciona ítems por popularidad y margen. Las líneas marcan los umbrales.</li>
          <li>Exporta datos en <strong>CSV</strong> (compatible con Excel/Sheets).</li>
        </ol>
      </section>); }
    function Stat({ label, value }) { return (<div className="border rounded-lg p-3 bg-slate-50"><div className="text-xs text-slate-500">{label}</div><div className="text-lg font-semibold">{value}</div></div>); }
    function Legend({ badge, text }) { return (<div className="flex items-center gap-2"><span className={`px-2 py-0.5 rounded text-xs ${badgeClass(badge)}`}>{labelFor(badge)}</span><span className="text-slate-500">{text}</span></div>); }
    const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App/>);
  </script>
</body>
</html>
